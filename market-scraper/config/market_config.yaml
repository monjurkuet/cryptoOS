# Market Scraper Configuration
# Controls trader scoring, filtering, buffering, and data retention

# Scoring Algorithm Weights (should sum to 100 for proper weighting)
scoring:
  weights:
    all_time_roi: 30      # 30% weight on all-time ROI
    month_roi: 25         # 25% weight on month ROI
    week_roi: 20          # 20% weight on week ROI
    account_value: 15     # 15% weight on account value
    volume: 10            # 10% weight on trading volume

  # Bonus points
  consistency_bonus: 5    # +5 points if all timeframes positive

  # ROI multipliers (how much to multiply ROI by for score)
  roi_multipliers:
    all_time: 30          # max 30 points
    month: 50             # max 25 points
    week: 100             # max 20 points (can be -10)

# Account Value Scoring Tiers
account_value_tiers:
  - threshold: 10000000   # $10M+
    points: 15
  - threshold: 5000000    # $5M+
    points: 12
  - threshold: 1000000    # $1M+
    points: 8
  - threshold: 100000     # $100K+
    points: 4
  - threshold: 0
    points: 0

# Volume Scoring Tiers (monthly volume)
volume_tiers:
  - threshold: 100000000  # $100M+
    points: 10
  - threshold: 50000000   # $50M+
    points: 7
  - threshold: 10000000   # $10M+
    points: 4
  - threshold: 1000000    # $1M+
    points: 2
  - threshold: 0
    points: 0

# Filter Criteria - Traders must match ALL filters
filters:
  min_score: 50              # Minimum score to be tracked (0-100+)
  max_count: 500             # Maximum traders to track
  min_account_value: 10000   # Minimum account value ($10K)

  # Optional: Require specific performance
  require_positive:
    all_time: false          # Require positive all-time ROI
    month: false             # Require positive month ROI
    week: false              # Require positive week ROI

  # Optional: Exclude traders
  exclude:
    addresses: []            # List of addresses to exclude
    tags: []                 # List of tags to exclude

# Tag Configuration
tags:
  whale:
    threshold: 10000000      # Account value >= $10M
  large:
    threshold: 1000000       # Account value >= $1M
  top_performer:
    min_score: 80            # Score >= 80
  elite:
    min_score: 90            # Score >= 90
  consistent:
    require_positive:
      - day
      - week
      - month                # All timeframes positive
  high_performer:
    all_time_roi: 1.0        # 100%+ all-time ROI
  high_volume:
    monthly_volume: 100000000  # $100M+ monthly volume
  medium_volume:
    monthly_volume: 10000000   # $10M+ monthly volume

# Position Inference Configuration
position_inference:
  enabled: true
  confidence_threshold: 0.5  # Minimum confidence to consider

  # Indicators of active position
  indicators:
    day_roi_threshold: 0.0001      # 0.01% day ROI indicates position
    pnl_ratio_threshold: 0.001     # 0.1% PnL/account ratio
    day_volume_threshold: 100000   # $100K daily volume

# Storage Configuration
storage:
  # How often to refresh tracked traders (seconds)
  refresh_interval: 3600  # 1 hour

  # Keep history of leaderboard snapshots
  keep_snapshots: true

  # Keep score history for trend analysis
  keep_score_history: false

  # Per-collection retention (days) - automatic deletion via MongoDB TTL indexes
  retention:
    events: 7                  # Raw events (catch-all audit log)
    leaderboard_history: 90    # Leaderboard snapshots
    trader_positions: 30       # Position snapshots
    trader_scores: 90          # Score history
    signals: 30                # Trading signals
    trader_signals: 30         # Per-trader signals
    mark_prices: 30            # Mark price data
    trades: 7                  # Raw trade data
    orderbook: 7               # Orderbook snapshots
    candles: 30                # OHLCV candles

# Buffer and Flush Configuration
# Controls how events are batched before being saved to MongoDB
buffer:
  # How often to automatically flush buffered events to database (seconds)
  # Lower values = more frequent writes, lower latency
  # Higher values = fewer writes, better throughput
  flush_interval: 50.0

  # Maximum number of events to buffer before forced flush
  # Lower values = more frequent writes
  # Higher values = better batching, more memory usage
  max_size: 100

  # Maximum messages to batch for WebSocket broadcasts
  broadcast_batch_size: 100

  # Maximum milliseconds to wait before flushing broadcast batch
  broadcast_batch_timeout_ms: 10.0

# Candle Backfill Configuration
# Fetches historical OHLCV data on startup instead of real-time WebSocket storage
candle_backfill:
  enabled: true

  # Start date for backfill (ISO format)
  # Set to null to use earliest available data from Hyperliquid
  # Hyperliquid launched ~2023, so data before then won't exist
  start_date: null  # or "2023-01-01" for explicit date

  # Timeframes to backfill (only 1h and above to reduce storage)
  timeframes:
    - "1h"
    - "4h"
    - "1d"

  # Batch size per API request (number of candles)
  batch_size: 500

  # Delay between API requests (seconds) to avoid rate limits
  rate_limit_delay: 0.5

  # Run backfill on every startup (checks for missing data first)
  run_on_startup: true

  # Smart backfill: only fetch data that doesn't exist in DB
  # Queries latest candle timestamp and fetches from there to now
  incremental: true

# Scheduler Configuration
# Controls periodic background tasks
scheduler:
  enabled: true

  # Periodic tasks configuration
  tasks:
    # Leaderboard refresh - fetch latest trader rankings
    leaderboard_refresh:
      enabled: true
      interval_seconds: 3600  # 1 hour

    # Health check - verify all components are healthy
    health_check:
      enabled: true
      interval_seconds: 600  # 10 minutes

    # Data cleanup - remove old data based on retention settings
    data_cleanup:
      enabled: false  # Disabled by default (use MongoDB TTL indexes instead)
      interval_seconds: 86400  # 24 hours

    # Connector health - check on-chain connector status
    connector_health:
      enabled: true
      interval_seconds: 600  # 10 minutes

    # Data archival - archive data before TTL deletion
    archival:
      enabled: false  # Enable via ARCHIVE_REPO_URL env var
      interval_seconds: 2592000  # 30 days (monthly)
      # Note: Requires ARCHIVE_REPO_URL environment variable to be set

# Data Archival Configuration
# Archives data before TTL deletion for long-term storage
archival:
  enabled: false  # Enable via environment variable or config override

  # Archive schedule (runs via scheduler)
  schedule: "monthly"  # daily, weekly, monthly

  # Compression settings
  compression:
    algorithm: "zstd"
    level: 3  # 1=fastest, 22=best ratio, 3=balanced

  # Git LFS configuration for archive storage
  git_lfs:
    repo_url: "${ARCHIVE_REPO_URL}"  # Set in .env
    branch: "main"
    local_cache: "/data/archives/repo"

  # Local cache for archive files before push
  local_cache: "/data/archives"

  # Collections to archive (matches retention keys)
  collections:
    - trader_positions
    - signals
    - leaderboard_history
    - candles

  # Archive data older than retention_days before TTL deletion
  archive_before_ttl_days: 2  # Archive 2 days before TTL expires

